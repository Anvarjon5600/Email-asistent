import logging
import google.generativeai as genai
from config import Config

logger = logging.getLogger(__name__)


class GeminiClient:
    def __init__(self):
        if not Config.GEMINI_API_KEY:
            logger.warning("GEMINI_API_KEY –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω")
            self.model = None
        else:
            try:
                genai.configure(api_key=Config.GEMINI_API_KEY)
                self.model = genai.GenerativeModel("gemini-2.5-flash")
                logger.info("Gemini AI —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Gemini: {e}")
                self.model = None

    def analyze_email_for_reminder(self, email_subject: str, email_body: str) -> str:
        """–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç email –∏ —Å–æ–∑–¥–∞–µ—Ç —É–º–Ω–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ"""
        if not self.model:
            return f"üìß {email_subject}\n{email_body}..."

        try:
            prompt = f"""
            –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–µ –ø–∏—Å—å–º–æ –∏ —Å–æ–∑–¥–∞–π –ø–æ –Ω–µ–º—É —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ, –∫—Ä–∞—Ç–∫–æ–µ –∏ –ø–æ–ª–µ–∑–Ω–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

            –û–°–û–ë–´–ï –ò–ù–°–¢–†–£–ö–¶–ò–ò:
            1.–ê–Ω–∞–ª–∏–∑ —Ü–µ–ø–æ—á–∫–∏ –ø–∏—Å–µ–º: –ï—Å–ª–∏ –ø–∏—Å—å–º–æ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–æ (forwarded) –∏–ª–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –≤–ª–æ–∂–µ–Ω–Ω—É—é –ø–µ—Ä–µ–ø–∏—Å–∫—É, –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–∞–º—É—é –ø–æ—Å–ª–µ–¥–Ω—é—é –∏ –æ—Å–Ω–æ–≤–Ω—É—é —á–∞—Å—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç–∞, –∫–æ—Ç–æ—Ä–∞—è —è–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏—á–∏–Ω–æ–π –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è.
            2.–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö:** –î–ª—è –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –ø–∏—Å–µ–º **–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∏–∑–≤–ª–µ–∫–∏ –∏ —É–∫–∞–∂–∏**:
                –ö—Ç–æ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å (–æ—Ç –∫–æ–≥–æ –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ –ø—Ä–∏—à–ª–æ –ø–∏—Å—å–º–æ).
                –ö—Ç–æ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏–ª (–æ—Ç –∫–æ–≥–æ –æ–Ω–æ –ø—Ä–∏—à–ª–æ —Ç–µ–±–µ).
            3.–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Å—ã–ª–æ–∫: –ï—Å–ª–∏ –≤ –∫–ª—é—á–µ–≤–æ–π —á–∞—Å—Ç–∏ –ø–∏—Å—å–º–∞ –µ—Å—Ç—å **–≤–∞–∂–Ω—ã–µ —Å—Å—ã–ª–∫–∏** (–Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ, –¥–æ–∫—É–º–µ–Ω—Ç—ã, –≤—Å—Ç—Ä–µ—á–∏ –∏ —Ç.–¥.), –∏–∑–≤–ª–µ–∫–∏ –∏—Ö –∏ —á–µ—Ç–∫–æ —É–∫–∞–∂–∏, –¥–ª—è —á–µ–≥–æ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –∫–∞–∂–¥–∞—è —Å—Å—ã–ª–∫–∞.

            –ò–°–•–û–î–ù–´–ï –î–ê–ù–ù–´–ï:
            –¢–µ–º–∞ –ø–∏—Å—å–º–∞: {email_subject}
            –¢–µ–∫—Å—Ç –ø–∏—Å—å–º–∞: {email_body}

            –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:
            –°—Ç—Ä–æ–≥–æ –ø—Ä–∏–¥–µ—Ä–∂–∏–≤–∞–π—Å—è —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã:

            üéØ [–£—Ä–æ–≤–µ–Ω—å —Å—Ä–æ—á–Ω–æ—Å—Ç–∏: –ù–∏–∑–∫–∏–π/–°—Ä–µ–¥–Ω–∏–π/–í—ã—Å–æ–∫–∏–π/–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π] [–¢–∏–ø –ø–∏—Å—å–º–∞: –†–∞–±–æ—á–µ–µ/–õ–∏—á–Ω–æ–µ/–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ/–†–µ–∫–ª–∞–º–∞/–°–æ–±—ã—Ç–∏–µ/–ó–∞–ø—Ä–æ—Å]
            üìÖ –ö–ª—é—á–µ–≤—ã–µ –¥–µ—Ç–∞–ª–∏:
                   –î–∞—Ç—ã/Deadlines: [–£–∫–∞–∂–∏ –≤—Å–µ –¥–∞—Ç—ã, —Å—Ä–æ–∫–∏, –≤—Ä–µ–º—è –≤—Å—Ç—Ä–µ—á] –µ—Å–ª–∏ –Ω–µ—Ç —Ç–æ —Ç–æ–≥–¥–∞ –Ω–µ –Ω—É–∂–Ω–æ "–î–∞—Ç—ã/Deadlines"
                   –û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–∏: [–î–ª—è –æ–±—ã—á–Ω–æ–≥–æ –ø–∏—Å—å–º–∞: –∫—Ç–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å. –î–ª—è –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–≥–æ: "–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏–ª: [–ò–º—è], –ò—Å—Ö–æ–¥–Ω—ã–π –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å: [–ò–º—è]"] –µ—Å–ª–∏ –Ω–µ—Ç —Ç–æ —Ç–æ–≥–¥–∞ –Ω–µ –Ω—É–∂–Ω–æ "–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–∏"
            üìù –°—É—Ç—å –ø–∏—Å—å–º–∞: –ö—Ä–∞—Ç–∫–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ (2-6 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è). –ò–∑–ª–æ–∂–∏ —Å–∞–º—É —Å—É—Ç—å –∏ –ø—Ä–∏—á–∏–Ω—É, –ø–æ –∫–æ—Ç–æ—Ä–æ–π –Ω—É–∂–Ω–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ. –û—Ç–≤–µ—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å: "–ß—Ç–æ –æ—Ç –º–µ–Ω—è —Ç—Ä–µ–±—É–µ—Ç—Å—è?"
            üîó–°—Å—ã–ª–∫–∏ –∏ –¥–µ–π—Å—Ç–≤–∏—è: [–ï—Å–ª–∏ –µ—Å—Ç—å —Å—Å—ã–ª–∫–∏, –ø–µ—Ä–µ—á–∏—Å–ª–∏ –∏—Ö –≤ —Ñ–æ—Ä–º–∞—Ç–µ: "‚Ä¢ [–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Å—Å—ã–ª–∫–∏]: [—Å–∞–º–∞ —Å—Å—ã–ª–∫–∞]"] –µ—Å–ª–∏ –Ω–µ—Ç —Ç–æ —Ç–æ–≥–¥–∞ –Ω–µ –Ω—É–∂–Ω–æ "–°—Å—ã–ª–∫–∏ –∏ –¥–µ–π—Å—Ç–≤–∏—è"

            –ö–†–ò–¢–ï–†–ò–ò –ö–ê–ß–ï–°–¢–í–ê –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–Ø:
            1.–ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è –Ω–∞ —Å—É—Ç–∏: –ò–∑–≤–ª–µ–∫–∞–π —Ç–æ–ª—å–∫–æ –∫–ª—é—á–µ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –Ω–µ–æ–±—Ö–æ–¥–∏–º—É—é –¥–ª—è –¥–µ–π—Å—Ç–≤–∏—è –∏–ª–∏ –æ—Å–≤–µ–¥–æ–º–ª–µ–Ω–Ω–æ—Å—Ç–∏.
            2.–Ø—Å–Ω–æ—Å—Ç—å –∏ –∫—Ä–∞—Ç–∫–æ—Å—Ç—å: –¢–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–Ω—è—Ç–Ω—ã–º –ø—Ä–∏ –±–µ–≥–ª–æ–º –ø—Ä–æ—Å–º–æ—Ç—Ä–µ.
            3.–ü–æ–ª–Ω–æ—Ç–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞: –¶–µ–ø–æ—á–∫–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ–π –¥–ª—è –ø–µ—Ä–µ—Å–ª–∞–Ω–Ω—ã—Ö –ø–∏—Å–µ–º –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —è—Å–Ω–∞.
            4.–ü—Ä–∞–∫—Ç–∏—á–Ω–æ—Å—Ç—å: –í—Å–µ —Å—Å—ã–ª–∫–∏ –∏–º–µ—é—Ç –ø–æ—è—Å–Ω–µ–Ω–∏–µ, –ø–æ deadlines –≤–∏–¥–Ω–∞ —Å—Ä–æ—á–Ω–æ—Å—Ç—å.
            5.–¢–æ–Ω –∏ —Å—Ç–∏–ª—å: –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏ –≤–µ–∂–ª–∏–≤—ã–π —Ç–æ–Ω, –∏–∑–±–µ–≥–∞–π –∏–∑–ª–∏—à–Ω–µ–π —Ñ–æ—Ä–º–∞–ª—å–Ω–æ—Å—Ç–∏.

            """

            response = self.model.generate_content(prompt)
            return (
                response.text if response.text else "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–∏—Å—å–º–æ"
            )

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –ø–∏—Å—å–º–∞ —Å Gemini: {e}")
            return f"üìß {email_subject}\n{email_body[:300]}..."

    def extract_dates_and_links(self, email_subject: str, email_body: str) -> dict:
        """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –¥–∞—Ç—ã –∏ —Å—Å—ã–ª–∫–∏ –∏–∑ –ø–∏—Å—å–º–∞"""
        if not self.model:
            return {"dates": [], "links": [], "summary": ""}

        try:
            prompt = f"""
            –ò–∑–≤–ª–µ–∫–∏ –∏–∑ —ç—Ç–æ–≥–æ –ø–∏—Å—å–º–∞ –≤—Å–µ –¥–∞—Ç—ã –∏ –≤–∞–∂–Ω—ã–µ —Å—Å—ã–ª–∫–∏.
            
            –¢–µ–º–∞: {email_subject}
            –¢–µ–∫—Å—Ç: {email_body[:2000]}
            
            –í–µ—Ä–Ω–∏ –æ—Ç–≤–µ—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON:
            {{
                "dates": ["YYYY-MM-DD", ...],
                "links": ["url1", "url2", ...],
                "summary": "–∫–æ—Ä–æ—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (1 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ)"
            }}
            
            –î–∞—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD.
            –°—Å—ã–ª–∫–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–æ–ª–Ω—ã–º–∏ URL.
            """

            response = self.model.generate_content(prompt)

            # –ü–æ–ø—Ä–æ–±—É–µ–º –∏–∑–≤–ª–µ—á—å JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞
            import json
            import re

            # –ò—â–µ–º JSON –≤ –æ—Ç–≤–µ—Ç–µ
            json_match = re.search(r"\{.*\}", response.text, re.DOTALL)
            if json_match:
                try:
                    return json.loads(json_match.group())
                except:
                    pass

            # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            return {
                "dates": [],
                "links": [],
                "summary": "–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é",
            }

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏ –¥–∞—Ç –∏ —Å—Å—ã–ª–æ–∫: {e}")
            return {"dates": [], "links": [], "summary": ""}


gemini_client = GeminiClient()
