import logging
import google.generativeai as genai
from config import Config

logger = logging.getLogger(__name__)


class GeminiClient:
    def __init__(self):
        if not Config.GEMINI_API_KEY:
            logger.warning("GEMINI_API_KEY –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω")
            self.model = None
        else:
            try:
                genai.configure(api_key=Config.GEMINI_API_KEY)
                self.model = genai.GenerativeModel("gemini-1.5-flash")
                logger.info("Gemini AI —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Gemini: {e}")
                self.model = None

    def analyze_email_for_reminder(self, email_subject: str, email_body: str) -> str:
        """–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç email –∏ —Å–æ–∑–¥–∞–µ—Ç —É–º–Ω–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ"""
        if not self.model:
            return f"üìß {email_subject}\n{email_body[:200]}..."

        try:
            prompt = f"""
            –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —ç—Ç–æ –ø–∏—Å—å–º–æ –∏ —Å–æ–∑–¥–∞–π –∫—Ä–∞—Ç–∫–æ–µ, –ø–æ–ª–µ–∑–Ω–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
            –û–±—Ä–∞—Ç–∏ –æ—Å–æ–±–æ–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø–∏—Å—å–º–∞ - –∏–∑–≤–ª–µ–∫–∞–π –æ—Å–Ω–æ–≤–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –≤—Å–µ–≥–æ —Ç–µ–∫—Å—Ç–∞.
            
            –¢–µ–º–∞ –ø–∏—Å—å–º–∞: {email_subject}
            –¢–µ–∫—Å—Ç –ø–∏—Å—å–º–∞: {email_body}
            
            –ï—Å–ª–∏ –ø–∏—Å—å–º–æ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–µ –∏–ª–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –≤–ª–æ–∂–µ–Ω–Ω—ã–µ –ø–∏—Å—å–º–∞, –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç.
            –ï—Å–ª–∏ –µ—Å—Ç—å –≤–∞–∂–Ω—ã–µ —Å—Å—ã–ª–∫–∏, —É–∫–∞–∂–∏ –∏—Ö –≤ –∫–ª—é—á–µ–≤—ã—Ö –¥–µ—Ç–∞–ª—è—Ö –∏ –¥–ª—è —á–µ–≥–æ —ç—Ç–æ —Å—Å—ã–ª–∫–∞.

            –°–æ–∑–¥–∞–π –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ:
            1. –í—ã–¥–µ–ª—è–µ—Ç –∫–ª—é—á–µ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é (–¥–∞—Ç—ã, deadlines, –∑–∞–¥–∞—á–∏, —Å–æ–±—ã—Ç–∏—è)
            2. –ö—Ä–∞—Ç–∫–æ–µ –∏ –ø–æ–Ω—è—Ç–Ω–æ–µ (–º–∞–∫—Å–∏–º—É–º 3-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
            3. –£–∫–∞–∑—ã–≤–∞–µ—Ç —É—Ä–æ–≤–µ–Ω—å —Å—Ä–æ—á–Ω–æ—Å—Ç–∏ (–Ω–∏–∑–∫–∏–π, —Å—Ä–µ–¥–Ω–∏–π, –≤—ã—Å–æ–∫–∏–π, –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π)
            4. –ò–∑–≤–ª–µ–∫–∞–µ—Ç —Å—Å—ã–ª–∫–∏ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∏–ª–∏ –≤–∞–∂–Ω—ã–µ URL
            5. –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø –ø–∏—Å—å–º–∞ (—Ä–∞–±–æ—á–µ–µ, –ª–∏—á–Ω–æ–µ, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ, —Ä–µ–∫–ª–∞–º–∞, —Å–æ–±—ã—Ç–∏–µ)
            
            –ï—Å–ª–∏ –ø–∏—Å—å–º–æ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–µ –∏–ª–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –≤–ª–æ–∂–µ–Ω–Ω—ã–µ –ø–∏—Å—å–º–∞, –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç.
            –ï—Å–ª–∏ –µ—Å—Ç—å –≤–∞–∂–Ω—ã–µ —Å—Å—ã–ª–∫–∏, —É–∫–∞–∂–∏ –∏—Ö –≤ –∫–ª—é—á–µ–≤—ã—Ö –¥–µ—Ç–∞–ª—è—Ö.
            
            –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
            üéØ [–£—Ä–æ–≤–µ–Ω—å —Å—Ä–æ—á–Ω–æ—Å—Ç–∏] [–¢–∏–ø –ø–∏—Å—å–º–∞]
            üìù –ö—Ä–∞—Ç–∫–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
            üìÖ –ö–ª—é—á–µ–≤—ã–µ –¥–µ—Ç–∞–ª–∏ (–¥–∞—Ç—ã, deadlines, —Å—Å—ã–ª–∫–∏)
            """

            response = self.model.generate_content(prompt)
            return (
                response.text if response.text else "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–∏—Å—å–º–æ"
            )

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –ø–∏—Å—å–º–∞ —Å Gemini: {e}")
            return f"üìß {email_subject}\n{email_body[:300]}..."

    def extract_dates_and_links(self, email_subject: str, email_body: str) -> dict:
        """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –¥–∞—Ç—ã –∏ —Å—Å—ã–ª–∫–∏ –∏–∑ –ø–∏—Å—å–º–∞"""
        if not self.model:
            return {"dates": [], "links": [], "summary": ""}

        try:
            prompt = f"""
            –ò–∑–≤–ª–µ–∫–∏ –∏–∑ —ç—Ç–æ–≥–æ –ø–∏—Å—å–º–∞ –≤—Å–µ –¥–∞—Ç—ã –∏ –≤–∞–∂–Ω—ã–µ —Å—Å—ã–ª–∫–∏.
            
            –¢–µ–º–∞: {email_subject}
            –¢–µ–∫—Å—Ç: {email_body[:2000]}
            
            –í–µ—Ä–Ω–∏ –æ—Ç–≤–µ—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON:
            {{
                "dates": ["YYYY-MM-DD", ...],
                "links": ["url1", "url2", ...],
                "summary": "–∫–æ—Ä–æ—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (1 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ)"
            }}
            
            –î–∞—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD.
            –°—Å—ã–ª–∫–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–æ–ª–Ω—ã–º–∏ URL.
            """

            response = self.model.generate_content(prompt)

            # –ü–æ–ø—Ä–æ–±—É–µ–º –∏–∑–≤–ª–µ—á—å JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞
            import json
            import re

            # –ò—â–µ–º JSON –≤ –æ—Ç–≤–µ—Ç–µ
            json_match = re.search(r"\{.*\}", response.text, re.DOTALL)
            if json_match:
                try:
                    return json.loads(json_match.group())
                except:
                    pass

            # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            return {
                "dates": [],
                "links": [],
                "summary": "–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é",
            }

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏ –¥–∞—Ç –∏ —Å—Å—ã–ª–æ–∫: {e}")
            return {"dates": [], "links": [], "summary": ""}


gemini_client = GeminiClient()
